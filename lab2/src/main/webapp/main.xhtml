<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
>
    <h:head>
        <meta name="viewport" content="initial-scale=1.0" />
        <meta http-equiv="Content-Type" content="text/html" />
        <title>Проверка точки</title>
        <h:outputStylesheet library="css" name="style.css" />
    </h:head>
    <h:body>
        <div id="header">
            <h:outputText value="ФИО: Хабнер Георгий Евгеньевич" /><br />
            <h:outputText value="Группа: P3231" /><br />
            <h:outputText value="Вариант: 912737" /><br />
        </div>

        <h:form id="points-select">
            <div id="x-select">
                <h:outputText value="Coordinate X" />
                <ui:repeat value="#{xBean.XValues}" var="xValue">
                    <h:commandLink
                        action="#{xBean.setValue(xValue)}"
                        styleClass="coords-input"
                        value="#{xValue}"
                    >
                        <f:ajax execute="@form" render="@form" />
                    </h:commandLink>
                </ui:repeat>
                <h:inputHidden
                    id="x"
                    value="#{xBean.value}"
                    validator="#{xBean.validate}"
                />
                <h:message for="x" />
            </div>

            <div id="y-select">
                <h:outputLabel for="y" value="Coordinate Y" />
                <h:inputText
                    id="y"
                    styleClass="coords-input"
                    value="#{yBean.value}"
                    maxlength="7"
                    size="7"
                    validator="#{yBean.validate}"
                    >
                    <!-- <f:convertNumber type="number" pattern="#,##0.00" /> -->
                    <f:convertNumber pattern="#,##0.00" />
                </h:inputText>
                <h:message for="y" />
            </div>

            <div id="r-select">
                <h:outputLabel for="r" value="Coordinate R" />
                <p:outputPanel>
                    <p:spinner
                        id="r"
                        styleClass="spinnerField"
                        value="#{rBean.value}"
                        min="1.0"
                        max="3.0"
                        stepFactor="0.5"
                    >
                        <p:ajax
                            process="@this"
                            update="canvas-panel results-table"
                        />
                    </p:spinner>
                </p:outputPanel>
                <h:message for="r" />
            </div>

            <div id="smt-button">
                <h:commandButton value="Send" styleClass="button">
                    <f:ajax
                        execute="@form"
                        listener="#{resultsControllerBean.addResult(xBean.value, yBean.value, rBean.value)}"
                        render="@form results-table canvas-panel"
                    />
                </h:commandButton>
            </div>

            <div id="clear-button">
                <h:commandButton
                    value="Clear"
                    styleClass="button"
                    action="#{resultsControllerBean.clearResults}"
                    render="@form results-table canvas-panel"
                />
            </div>
        </h:form>

        <canvas
            id="canvas"
            width="740px"
            height="740px"
            class="canvas"
            onclick="clickPoint(event);"
        ></canvas>

        <h:dataTable
            id="results-table"
            var="result"
            value="#{resultsControllerBean.results}"
        >
            <h:column>
                <f:facet name="header">X</f:facet>
                <h:outputText value="#{result.x}" />
            </h:column>
            <h:column>
                <f:facet name="header">Y</f:facet>
                <h:outputText value="#{result.y}" />
            </h:column>
            <h:column>
                <f:facet name="header">R</f:facet>
                <h:outputText value="#{result.r}" />
            </h:column>
            <h:column>
                <f:facet name="header">Result</f:facet>
                <h:outputText value="#{result.result}" />
            </h:column>
            <h:column>
                <f:facet name="header">Time</f:facet>
                <h:outputText value="#{result.time}" />
            </h:column>
            <h:column>
                <f:facet name="header">Execution time</f:facet>
                <h:outputText value="#{result.executionTime}" />
            </h:column>
        </h:dataTable>

        <h:form id="page-back">
            <h:commandLink value="Перейти назад" action="index" />
        </h:form>

        <p:outputPanel id="canvas-panel">
            <script>

                    #{resultsControllerBean.updateR(rBean.value)}
                    var r = #{rBean.value};
                    results = [];
                    <ui:repeat var="result" value="#{resultsControllerBean.results}">
                        results.push({
                            x: #{result.x},
                            y: #{result.y},
                            r: r,
                            result: "#{result.result}",
                        });
                    </ui:repeat>
                    drawGraph(#{rBean.value}, results);                    
            </script>
        </p:outputPanel>

        <h:outputScript library="js" name="drawer.js" />

        <h:outputScript>
            drawGraph(#{rBean.value}, results);
        </h:outputScript>

        <h:form id="click-form">
            <h:inputHidden id="x-click" value="#{xBean.value}" />
            <h:inputHidden id="y-click" value="#{yBean.value}" />
            <p:remoteCommand
                name="clickGraph"
                action="#{resultsControllerBean.addResult(xBean.value, yBean.value, rBean.value)}"
                update="x-click y-click results-table canvas-panel"
            />
        </h:form>
    </h:body>
</html>
